# 서비스를 운영해보면서 느낀점
## AWS
1. IAM
   1. 서비스에서는 IAM User(Access Key, Secret Key) 를 통해 권한(Permission)을 획득하는 것이 아닌, IAM Role을 Assume 하여 권한을 획득하는 것을 권장한다.
      1. EKS : Service Accounts 에 IAM Role 설정
      2. EC2 : IAM Role Attatch
   2. 서비스를 운영할 때 운영 환경에서 설정하는 권한은 매우 타이트하게 설정해야한다.
      1. 명확히 필요한 권한만 부여함으로써 서비스의 안정성을 확보하는 것이 중요하다.
      2. 간혹 전체 권한을 부여할 수 있도록 요청이 오지만, 이는 바로 잡아야하므로 개발 환경에서 정말 필요한 권한이 무엇인지 파악하여 재요청을 주도록 요청해야한다.
2. 보안을 위해 WAF, NACL, SG 에 엄격히 통제해야한다.
3. 비용 최적화

## Docker

요청 내용

```
openjdk:17-slim-buster 이미지를 사용하는 곳이 많은데, 특정 버전을 사용하지 않으면 문제가 발생할 수 있는 것인지??,
또 adoptopenjdk/openjdk17 버전을 찾아보려고 했는데 없는 것 같아서, 이럴땐 어떤 builder와 runner를 사용해야되는지??
```

구체적인 버전이 명시되지 않은 Docker 이미지 태그를 사용할 경우, 잠재적으로 이미지가 예기치 않게 업데이트될 수 있어 최종적으로 빌드되는 아티팩트가 달라질 수 있습니다. 이로 인해 장애가 발생했을 때 문제가 내 코드 때문인지, 아니면 이미지 자체의 변경 때문인지 쉽게 파악하기 어려워집니다. 따라서 반드시 특정 버전이 명시된 태그를 사용하여 이미지를 고정하는 것을 강력히 권장합니다.
- (EX. adoptopenjdk/openjdk11 -> adoptopenjdk/openjdk11:alpine-jre-11.0.11_9)

openjdk, adoptopenjdk 는 이미 본인들의 이미지에 대하여 deprecation 공지를 올린 것으로 확인. 따라서, 대안으로 새로운 base image를 찾아야 하는데 아래의 것들이 추천되는 것으로 확인된다.

1. amazoncorretto
2. eclipse-temurin
3. ibm-semeru-runtimes
4. ibmjava
5. sapmachine

또한, 서비스 안정성을 위해서는 imagePullPolicy: `IfNotPresent` + 고정된 이미지 태그 (v1.0.0과 같은...) 로 작성하여 예측하지 못한 이미지 태그 변경으로 인한 장애 또는 이슈를 막습니다.

## Kubernetes

1. **Kubernetes Manifest 관리**
   * EKS에 배포되는 모든 Kubernetes Manifest는 Helm Chart를 통해 관리하고, ArgoCD를 통해 배포하는 것이 관리에 용이하다.
   * 단 하나의 Manifest(예: Deployment)라도 `kubectl`이 아닌 ArgoCD를 통해 배포되도록 한다.

2. **Secret 관리**
   * GitOps 방식에서는 Git에 Secret 값이 노출되지 않도록 Secret 관리가 매우 중요하다.
   * Helm Secret, External Secret 등 안전한 방법을 활용한다.

3. **리소스(CPU, Memory) 최적화**
   * CPU Throttling, Memory Leak 등 성능 문제를 예방하기 위해 리소스 할당을 최적화해야 한다.
   * Memory Leak 문제는 서비스가 많은 데이터를 처리할 때 발생할 수 있으므로, 데이터 사용 패턴을 파악하는 것이 중요하다.

4. **서비스 초기화(Warm-up) 최적화**
   * 서비스가 시작될 때 처리해야 할 동작이 많으면 CPU 사용량이 급증해 Pod가 재시작될 가능성이 있다. 이를 최소화해야 한다.
   * Probe 설정과 리소스 최적화를 통해 안정성을 확보한다.

5. **EKS Node Role 관리**
   * 간혹 EKS Node Role을 임시로 assume하여 서비스가 운영되는 경우가 있는데, 이는 잘못된 접근 방식이며 코드 단에서 수정이 필요하다.
   * 예시: `arn:aws:sts::{AWS Accounts ID}:assumed-role/{EKS Node Role}/i-06c7b83f4ee78d8a7`
   * Node Role에는 최소한의 권한만 부여한다.
     * `AmazonEC2ContainerRegistryPowerUser`
     * `AmazonEKS_CNI_Policy`
     * `AmazonEKSWorkerNodePolicy`
     * `AmazonSSMManagedInstanceCore`

## Service

1. **API 접근 제한**
   * API는 토큰 인증 방식이 아니라면 반드시 internal로만 노출해야 하며, public으로 열 경우 보안상 위험이 커진다.

2. **단순한 구성 유지**
   * 시스템을 구성할 때는 항상 가장 단순하게 설계하는 것이 중요하다.
   * 여러 기능을 이것저것 붙이다 보면 동작은 하지만 유지보수가 어려워지므로, 핵심만 남기고 단순하게 구성해야 한다.
